{% extends 'listings/base.html' %}
{% block title %}ì±„íŒ…ë°©{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white border border-gray-200 rounded-xl p-6">

    <h2 class="text-lg font-semibold mb-1">
        ğŸ’¬ {{ listing.title }} - ì±„íŒ…ë°©
    </h2>

    <p class="text-xs text-gray-600 mb-4">
        í˜„ì¬ íŒë§¤ ìƒíƒœ:
        {% if listing.status == 'S' %}
            <span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-[11px]">
                íŒë§¤ì¤‘
            </span>
        {% elif listing.status == 'R' %}
            <span class="px-2 py-0.5 rounded-full bg-yellow-50 text-yellow-700 text-[11px]">
                ì˜ˆì•½ì¤‘
            </span>
        {% elif listing.status == 'D' %}
            <span class="px-2 py-0.5 rounded-full bg-red-50 text-red-600 text-[11px]">
                ê±°ë˜ì™„ë£Œ
            </span>
        {% endif %}
    </p>

    <!-- ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ -->
    <div class="p-3 border border-gray-200 rounded-lg h-72 overflow-y-auto bg-gray-50 text-sm mb-4">
        {% for msg in messages_list %}
            <div class="mb-3">
                <p class="text-[11px] text-gray-400">{{ msg.created_at|date:"Y-m-d H:i" }}</p>
                <p class="font-semibold {% if msg.sender == user %}text-emerald-700{% else %}text-gray-700{% endif %}">
                    {{ msg.sender.username }}
                </p>
                <p class="text-gray-800">{{ msg.message }}</p>
            </div>
        {% empty %}
            <p class="text-gray-400 text-sm">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </div>

    <!-- 1. ë©”ì‹œì§€ ë³´ë‚´ê¸° í¼ -->
    <form method="post" class="space-y-2 text-sm mb-6">
        {% csrf_token %}
        {{ form }}

        <button type="submit"
                name="send_message"
                class="w-full bg-emerald-500 text-white py-2 rounded-lg hover:bg-emerald-600">
            ë©”ì‹œì§€ ë³´ë‚´ê¸°
        </button>
    </form>

    <!-- 2. íŒë§¤ ìƒíƒœ ë³€ê²½ í¼ (íŒë§¤ìë§Œ) -->
    {% if user == listing.seller %}
        <form method="post" class="pt-3 border-t border-gray-100 space-y-2 text-sm">
            {% csrf_token %}
            <input type="hidden" name="update_status" value="1">

            <label class="block mb-1 font-medium text-gray-800">íŒë§¤ ìƒíƒœ ë³€ê²½</label>
            <select name="status"
                    class="w-full border border-gray-300 px-2 py-2 rounded-lg text-sm">
                <option value="">-- ë³€ê²½ ì•ˆ í•¨ --</option>
                {% for value, label in STATUS_CHOICES %}
                    <option value="{{ value }}" {% if listing.status == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>

            <button type="submit"
                    class="w-full bg-gray-900 text-white py-2 rounded-lg hover:bg-black">
                ìƒíƒœ ì—…ë°ì´íŠ¸
            </button>
        </form>
    {% endif %}

</div>
{% endblock %}
